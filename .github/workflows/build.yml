name: Build

on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:

# Workflow-level concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref_name != github.event.repository.default_branch }}

# Required permissions for Vault OIDC and repo operations
permissions:
  id-token: write
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    name: Prepare
    outputs:
      PACKAGE_VERSION: ${{ steps.project_version.outputs.PACKAGE_VERSION }}
      PROJECT_VERSION: ${{ steps.project_version.outputs.PROJECT_VERSION }}
      BUILD_NUMBER: ${{ steps.get-build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: SonarSource/ci-github-actions/get-build-number@v1
        id: get-build-number

      - name: Get project version
        id: project_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "PROJECT_VERSION=${PACKAGE_VERSION}.${{ steps.get-build-number.outputs.BUILD_NUMBER }}" >> $GITHUB_OUTPUT

      - name: Update GitHub Actions Summary
        run: |
          echo "## ðŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Package Version** | \`${{ steps.project_version.outputs.PACKAGE_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Project Version** | \`${{ steps.project_version.outputs.PROJECT_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ steps.get-build-number.outputs.BUILD_NUMBER }}\` |" >> $GITHUB_STEP_SUMMARY

  build:
    runs-on: ubuntu-latest
    name: Build and Test
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Prepare build
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          npm ci

      - name: Build
        run: npm run build

      - uses: SonarSource/ci-github-actions/build-npm@v1
        with:
          sonar-platform: sqc-eu
          deploy-pull-request: true

  test-all:
    name: Run All Tests
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - name: Run all tests
        run: npm run test:all

  build-binaries:
    name: Build Binary - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            artifact-name: sonar-cli-linux
            bun-target: bun-linux-x64
          - platform: macos
            os: macos-latest
            artifact-name: sonar-cli-macos
            bun-target: bun-darwin-arm64
          - platform: windows
            os: windows-latest
            artifact-name: sonar-cli-windows.exe
            bun-target: bun-windows-x64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: 2.77.0

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-qa-deployer access_token | ARTIFACTORY_DEPLOY_PASSWORD;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - name: Build binary
        run: bun build src/index.ts --compile --outfile dist/${{ matrix.artifact-name }} --target ${{ matrix.bun-target }}

      - name: Deploy binary to Artifactory QA
        shell: bash
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_DEPLOY_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_DEPLOY_PASSWORD }}
          ARTIFACTORY_DEPLOY_REPO: sonarsource-npm-public-qa
          PROJECT_VERSION: ${{ needs.prepare.outputs.PROJECT_VERSION }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.BUILD_NUMBER }}
          BUILD_NAME: ${{ github.event.repository.name }}
          ARTIFACT_NAME: ${{ matrix.artifact-name }}
        run: |
          echo "Deploying ${ARTIFACT_NAME} to Artifactory QA..."
          jf rt u "dist/${ARTIFACT_NAME}" \
            "${ARTIFACTORY_DEPLOY_REPO}/org/sonarsource/sonarlint/sonar-cli/${PROJECT_VERSION}/" \
            --url="${ARTIFACTORY_URL}" \
            --access-token="${ARTIFACTORY_DEPLOY_PASSWORD}" \
            --build-name="${BUILD_NAME}" \
            --build-number="${BUILD_NUMBER}"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: dist/${{ matrix.artifact-name }}
          retention-days: 7

  promote:
    name: Promote
    runs-on: ubuntu-latest
    needs: [prepare, build, build-binaries, test-all]
    if: github.event_name == 'pull_request' || github.ref_name == github.event.repository.default_branch || startsWith(github.ref_name, 'branch-') || startsWith(github.ref_name, 'dogfood-')
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: SonarSource/ci-github-actions/promote@v1
        env:
          PROJECT_VERSION: ${{ needs.prepare.outputs.PROJECT_VERSION }}
        with:
          promote-pull-request: true
