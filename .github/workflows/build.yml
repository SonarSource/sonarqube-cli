name: Build

on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:

# Workflow-level concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref_name != github.event.repository.default_branch }}

# Required permissions for Vault OIDC and repo operations
permissions:
  id-token: write
  contents: read

jobs:
  build-binaries:
    name: Build and Deploy Binaries
    runs-on: sonar-s-public
    outputs:
      PACKAGE_VERSION: ${{ steps.project_version.outputs.PACKAGE_VERSION }}
      PROJECT_VERSION: ${{ steps.project_version.outputs.PROJECT_VERSION }}
      BUILD_NUMBER: ${{ steps.get-build-number.outputs.BUILD_NUMBER }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: SonarSource/ci-github-actions/get-build-number@v1
        id: get-build-number

      - name: Get project version
        id: project_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "PROJECT_VERSION=${PACKAGE_VERSION}.${{ steps.get-build-number.outputs.BUILD_NUMBER }}" >> $GITHUB_OUTPUT

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@279b1f629f43dd5bc658d8361ac4802a7ef8d2d5
        with:
          version: 2.77.0

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-qa-deployer access_token | ARTIFACTORY_DEPLOY_PASSWORD;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - name: Build binaries for all platforms
        run: |
          echo "Building Linux binary..."
          bun build src/index.ts --compile --outfile dist/sonar-cli-linux --target bun-linux-x64
          
          echo "Building macOS binary..."
          bun build src/index.ts --compile --outfile dist/sonar-cli-macos --target bun-darwin-arm64
          
          echo "Building Windows binary..."
          bun build src/index.ts --compile --outfile dist/sonar-cli-windows.exe --target bun-windows-x64
          
          echo "✅ All binaries built successfully"
          ls -lh dist/

      - name: Deploy binaries to Artifactory QA
        shell: bash
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_DEPLOY_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_DEPLOY_PASSWORD }}
          ARTIFACTORY_DEPLOY_REPO: sonarsource-npm-public-qa
          PROJECT_VERSION: ${{ steps.project_version.outputs.PROJECT_VERSION }}
          BUILD_NUMBER: ${{ steps.get-build-number.outputs.BUILD_NUMBER }}
          BUILD_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Deploying binaries to Artifactory QA..."
          
          for artifact in sonar-cli-linux sonar-cli-macos sonar-cli-windows.exe; do
            echo "Uploading ${artifact}..."
            jf rt u "dist/${artifact}" \
              "${ARTIFACTORY_DEPLOY_REPO}/org/sonarsource/sonarlint/sonar-cli/${PROJECT_VERSION}/" \
              --url="${ARTIFACTORY_URL}" \
              --access-token="${ARTIFACTORY_DEPLOY_PASSWORD}" \
              --build-name="${BUILD_NAME}" \
              --build-number="${BUILD_NUMBER}"
          done
          
          echo "✅ All binaries deployed to Artifactory"

  build:
    runs-on: sonar-s-public
    name: Build and Scan with SonarQube
    needs: build-binaries
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Prepare build
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: |
          npm ci

      - uses: SonarSource/ci-github-actions/build-npm@v1
        with:
          sonar-platform: sqc-eu
          deploy-pull-request: true

  test-all:
    name: Run All Tests
    runs-on: sonar-s-public
    needs: build-binaries
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@v3
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@v1
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - name: Run all tests
        run: npm run test:all

  promote:
    name: Promote
    runs-on: sonar-s-public
    needs: [build-binaries, build, test-all]
    if: github.event_name == 'pull_request' || github.ref_name == github.event.repository.default_branch || startsWith(github.ref_name, 'branch-') || startsWith(github.ref_name, 'dogfood-')
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: SonarSource/ci-github-actions/promote@v1
        env:
          BUILD_NAME: ${{ github.event.repository.name }}
          BUILD_NUMBER: ${{ needs.build-binaries.outputs.BUILD_NUMBER }}
          PROJECT_VERSION: ${{ needs.build-binaries.outputs.PROJECT_VERSION }}
          ARTIFACTORY_DEPLOY_REPO: sonarsource-npm-public-qa
        with:
          promote-pull-request: true
