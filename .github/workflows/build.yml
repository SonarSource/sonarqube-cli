name: Build

on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:

# Workflow-level concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref_name != github.event.repository.default_branch }}

# Required permissions for Vault OIDC and repo operations
permissions:
  id-token: write
  contents: read

jobs:
  prepare:
    name: Prepare Build
    runs-on: sonar-s
    outputs:
      BUILD_NUMBER: ${{ steps.get-build-number.outputs.BUILD_NUMBER }}
      PROJECT_VERSION: ${{ steps.project_version.outputs.PROJECT_VERSION }}
      PACKAGE_VERSION: ${{ steps.project_version.outputs.PACKAGE_VERSION }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - uses: SonarSource/ci-github-actions/get-build-number@148774f456203f228b7bd1bd68ed0c22254d9cd1
        id: get-build-number

      - name: Get project version
        id: project_version
        shell: bash
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "PROJECT_VERSION=${PACKAGE_VERSION}.${{ steps.get-build-number.outputs.BUILD_NUMBER }}" >> $GITHUB_OUTPUT

  build-binaries:
    name: Build Binary - ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    needs: prepare
    strategy:
      matrix:
        include:
          - os: linux
            runner: sonar-s
            target: bun-linux-x64
            artifact: sonar-cli-linux
          - os: macos
            runner: macos-latest-xlarge
            target: bun-darwin-arm64
            artifact: sonar-cli-macos
          - os: windows
            runner: warp-custom-windows-2022-s
            target: bun-windows-x64
            artifact: sonar-cli-windows.exe
    steps:
      # TODO: need access to additional secrets to run this step
      # - name: Setup Cloudflare WARP (macOS only)
      #   if: matrix.os == 'macos'
      #   uses: SonarSource/gh-action_setup-cloudflare-warp@v1

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@279b1f629f43dd5bc658d8361ac4802a7ef8d2d5
        with:
          version: 2.77.0

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@320bd31b03e5dacaac6be51bbbb15adf7caccc32 # 3.1.0
        with:
          secrets: |
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-qa-deployer access_token | ARTIFACTORY_DEPLOY_PASSWORD;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@54a48984cf6564fd48f3c6c67c0891d7fe89604c
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - name: Build binary for ${{ matrix.os }}
        run: |
          echo "Building ${{ matrix.os }} binary..."
          bun build src/index.ts --compile --outfile dist/${{ matrix.artifact }} --target ${{ matrix.target }}
          echo "✅ Binary built successfully"

      - name: List built artifacts (Unix)
        if: matrix.os != 'windows'
        run: ls -lh dist/

      - name: List built artifacts (Windows)
        if: matrix.os == 'windows'
        run: dir dist\

      - name: Deploy binary to Artifactory QA
        shell: bash
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_DEPLOY_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_DEPLOY_PASSWORD }}
          ARTIFACTORY_DEPLOY_REPO: sonarsource-public-qa
          PROJECT_VERSION: ${{ needs.prepare.outputs.PROJECT_VERSION }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.BUILD_NUMBER }}
          BUILD_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Deploying ${{ matrix.artifact }} to Artifactory QA..."
          jf rt u "dist/${{ matrix.artifact }}" \
            "${ARTIFACTORY_DEPLOY_REPO}/org/sonarsource/cli/sonar-cli/${PROJECT_VERSION}/" \
            --flat=true \
            --url="${ARTIFACTORY_URL}" \
            --access-token="${ARTIFACTORY_DEPLOY_PASSWORD}" \
            --build-name="${BUILD_NAME}" \
            --build-number="${BUILD_NUMBER}"
          echo "✅ Binary deployed to Artifactory"

      - name: Publish build info
        shell: bash
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_DEPLOY_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_DEPLOY_PASSWORD }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.BUILD_NUMBER }}
          BUILD_NAME: ${{ github.event.repository.name }}
        run: |
          echo "Publishing build info for ${BUILD_NAME} #${BUILD_NUMBER}..."
          jf rt build-publish \
            --url="${ARTIFACTORY_URL}" \
            --access-token="${ARTIFACTORY_DEPLOY_PASSWORD}" \
            "${BUILD_NAME}" \
            "${BUILD_NUMBER}"
          echo "✅ Build info published"

  test-and-scan:
    name: Run Tests and Scan with SonarQube
    runs-on: sonar-s
    needs: [prepare, build-binaries]
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault Secrets
        id: secrets
        uses: SonarSource/vault-action-wrapper@320bd31b03e5dacaac6be51bbbb15adf7caccc32 # 3.1.0
        with:
          secrets: |
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Cache NPM dependencies
        uses: SonarSource/gh-action_cache@54a48984cf6564fd48f3c6c67c0891d7fe89604c
        with:
          path: |
            ~/.npm
            node_modules/
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}

      - name: Install dependencies
        env:
          ARTIFACTORY_PRIVATE_READER_USERNAME: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_READER_PASSWORD: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          NPM_CONFIG_registry: https://repox.jfrog.io/artifactory/api/npm/npm
          NPM_CONFIG_//repox.jfrog.io/artifactory/api/npm/:_authToken: ${{ fromJSON(steps.secrets.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
        run: npm ci

      - uses: SonarSource/ci-github-actions/build-npm@148774f456203f228b7bd1bd68ed0c22254d9cd1
        with:
          sonar-platform: sqc-eu
          deploy-pull-request: true

      - name: Run all tests
        run: npm run test:all

  promote:
    runs-on: sonar-s
    name: Promote
    needs:
      - prepare
      - build-binaries
      - test-and-scan
    env:
      PROJECT_VERSION: ${{ needs.prepare.outputs.PROJECT_VERSION }}
      ARTIFACTORY_DEPLOY_REPO: sonarsource-public-qa
    if: ${{ github.event_name == 'pull_request' || github.ref_name == github.event.repository.default_branch || startsWith(github.ref_name, 'branch-') || startsWith(github.ref_name, 'dogfood-on-') }}
    steps:
      - uses: SonarSource/ci-github-actions/promote@v1
        env:
          PROJECT_VERSION: ${{ needs.prepare.outputs.PROJECT_VERSION }}
        with:
            promote-pull-request: true
