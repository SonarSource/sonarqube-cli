#!/usr/bin/env node

// Main CLI entry point
// Generated from cli-spec.yaml by Plop.js

import { Command } from 'commander';
import { VERSION } from './version.js';
import { runCommand } from './lib/run-command.js';

// Constants for argument validation
const VALID_AGENTS = ['claude', 'gemini', 'codex'] as const;

{{{commandImports commands}}}

const program = new Command();

program
  .name('{{cli.name}}')
  .description('{{cli.description}}')
  .version(VERSION, '-v, --version', 'display version for command');

{{#each commands}}
{{#if subcommands}}
// {{description}}
const {{camelCase name}} = program
  .command('{{name}}')
  .description('{{description}}');

{{#each subcommands}}
{{camelCase ../name}}
  .command('{{name}}')
  .description('{{description}}')
{{#each options}}
{{#if required}}
  .requiredOption('{{#if alias}}-{{alias}}, {{/if}}--{{name}} <{{name}}>', '{{description}}')
{{else}}
  .option('{{#if alias}}-{{alias}}, {{/if}}--{{name}}{{#unless (eq type "boolean")}} <{{name}}>{{/unless}}', '{{description}}'{{#if default}}, '{{default}}'{{/if}})
{{/if}}
{{/each}}
  .action(async ({{#if options}}options{{/if}}) => {
{{#if managedExit}}
    await {{camelCase ../name}}{{pascalCase name}}Command({{#if options}}options{{/if}});
{{else}}
    await runCommand(() => {{camelCase ../name}}{{pascalCase name}}Command({{#if options}}options{{/if}}));
{{/if}}
  });

{{/each}}
{{else}}
// {{description}}
program
  .command('{{name}}{{#if arguments}}{{#each arguments}}{{#if required}} <{{name}}>{{else}} [{{name}}]{{/if}}{{/each}}{{/if}}')
  .description('{{description}}')
{{#each options}}
{{#if required}}
  .requiredOption('{{#if alias}}-{{alias}}, {{/if}}--{{name}} <{{name}}>', '{{description}}')
{{else}}
  .option('{{#if alias}}-{{alias}}, {{/if}}--{{name}}{{#unless (eq type "boolean")}} <{{name}}>{{/unless}}', '{{description}}'{{#if default}}, '{{default}}'{{/if}})
{{/if}}
{{/each}}
  .action(async ({{#if arguments}}{{#each arguments}}{{name}}, {{/each}}options{{else}}{{#if options}}options{{/if}}{{/if}}) => {
    await runCommand(async () => {
{{#if arguments}}
{{#each arguments}}
{{#if choices}}
{{#if (eq name "agent")}}
      if (!VALID_AGENTS.includes({{name}})) {
        throw new Error(`Invalid {{name}}. Must be one of: ${VALID_AGENTS.join(', ')}`);
      }
{{else}}
      const valid{{pascalCase name}} = [{{#each choices}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}];
      if (!valid{{pascalCase name}}.includes({{name}})) {
        throw new Error(`Invalid {{name}}. Must be one of: {{#each choices}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}`);
      }
{{/if}}
{{/if}}
{{/each}}
{{/if}}
      await {{camelCase name}}Command({{#if arguments}}{{#each arguments}}{{name}}, {{/each}}options{{else}}{{#if options}}options{{/if}}{{/if}});
    });
  });

{{/if}}
{{/each}}

const AUTH_ARGC_WITHOUT_SUBCOMMAND = 3;

// Handle `sonar auth` without subcommand (defaults to login)
if (process.argv.length === AUTH_ARGC_WITHOUT_SUBCOMMAND && process.argv[2] === 'auth') {
  // User ran `sonar auth` without subcommand - inject 'login' subcommand
  process.argv.splice(AUTH_ARGC_WITHOUT_SUBCOMMAND, 0, 'login');
}

program.parse();
